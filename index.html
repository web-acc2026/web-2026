<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Public OTP Terminal</title>
    <script src="https://cdn.jsdelivr.net/npm/appwrite@11.0.0"></script>
    <style>
        body { background: #000; color: white; font-family: 'Segoe UI', sans-serif; display: flex; justify-content: center; padding: 20px; margin: 0; }
        .container { width: 100%; max-width: 400px; }
        .card { 
            background: #111; border-radius: 20px; padding: 20px; margin-bottom: 25px; text-align: center;
            border: 2px solid transparent; 
            background-image: linear-gradient(#111, #111), linear-gradient(45deg, #00ffcc, #ff0055, #fbff00);
            background-origin: border-box; background-clip: content-box, border-box;
            animation: borderRotate 5s linear infinite;
        }
        @keyframes borderRotate { 100% { filter: hue-rotate(360deg); } }
        
        .mail-item { 
            background: #1a1a1a; padding: 15px; border-radius: 12px; margin-bottom: 10px; 
            display: flex; justify-content: space-between; align-items: center; border: 1px solid #333; 
        }
        .mail-text { color: #00ff00; font-weight: bold; font-size: 14px; overflow: hidden; text-overflow: ellipsis; }
        .copy-btn { background: #333; color: #fff; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: bold; }
        .copy-btn:active { background: #555; }

        .otp-display { 
            background: #000; border-radius: 15px; padding: 30px 0; font-size: 60px; 
            color: #00ff00; font-weight: bold; text-shadow: 0 0 20px rgba(0,255,0,0.5); 
            border: 1px solid #222; margin-top: 10px; letter-spacing: 5px;
        }
        .sync-text { font-size: 12px; color: #0088ff; margin-top: 15px; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .dot { width: 8px; height: 8px; background: #00ff00; border-radius: 50%; animation: blink 1s infinite; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <div style="font-size: 11px; color: #888; text-align: left; margin-bottom: 12px; font-weight: bold;">1. TAP TO COPY ACTIVE MAIL</div>
            <div id="mail-list">
                <div style="color: #444; padding: 10px;">Loading mail list...</div>
            </div>
        </div>

        <div class="card">
            <div style="font-size: 11px; color: #888; text-align: left; margin-bottom: 12px; font-weight: bold;">2. LIVE OTP RECEIVER (INBOX + SPAM)</div>
            <div id="otp-screen" class="otp-display">0000</div>
            <div class="sync-text"><div class="dot"></div> SYNCING WITH ADMIN...</div>
        </div>
    </div>

<script>
    // Appwrite Config
    const client = new Appwrite.Client()
        .setEndpoint('https://sgp.cloud.appwrite.io/v1')
        .setProject('6990a457003d6b0bbf82');

    const databases = new Appwrite.Databases(client);
    const DB_ID = '6990a481001f67225b44';
    const COL_ID = 'user_messages';

    async function updateDashboard() {
        try {
            // Document များအားလုံးကို createdAt အလိုက် နောက်ဆုံးတစ်ခုကနေ စီဆွဲမည်
            const res = await databases.listDocuments(DB_ID, COL_ID, [
                Appwrite.Query.orderDesc('$createdAt'),
                Appwrite.Query.limit(15)
            ]);

            let mailHtml = "";
            let foundOTP = false;

            res.documents.forEach(doc => {
                const val = doc.current_otp; // သင့် Column နာမည် အတိအကျ
                if (!val) return;

                // Email ဖြစ်မဖြစ် စစ်ဆေးခြင်း
                if (val.includes("@")) {
                    mailHtml += `
                        <div class="mail-item">
                            <span class="mail-text">${val}</span>
                            <button class="copy-btn" onclick="copyText('${val}')">COPY</button>
                        </div>`;
                } else {
                    // Email မဟုတ်ပါက OTP အဖြစ် သတ်မှတ်ပြီး ပထမဆုံးတွေ့သော ဂဏန်းကို ပြမည်
                    if (!foundOTP) {
                        document.getElementById('otp-screen').innerText = val;
                        foundOTP = true;
                    }
                }
            });

            // Email စာရင်း ထည့်သွင်းခြင်း
            document.getElementById('mail-list').innerHTML = mailHtml || "<div style='color:#444'>No active mails found.</div>";
            
            // တကယ်လို့ ဂဏန်းလုံးဝ မတွေ့ရင် 0000 ပြန်ပြမည်
            if (!foundOTP) {
                document.getElementById('otp-screen').innerText = "0000";
            }

        } catch (e) { 
            console.error("Sync Error:", e);
        }
    }

    function copyText(text) {
        navigator.clipboard.writeText(text).then(() => {
            alert("Copied: " + text);
        });
    }

    // ၂ စက္ကန့်တစ်ခါ Database ကို စစ်ဆေးမည်
    setInterval(updateDashboard, 2000);
    window.onload = updateDashboard;
</script>
</body>
</html>
