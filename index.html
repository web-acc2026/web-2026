<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RGB User - Spam Enabled OTP</title>
    <script src="https://cdn.jsdelivr.net/npm/appwrite@11.0.0"></script>
    <script src="https://accounts.google.com/gsi/client" onload="initClient()"></script>
    <style>
        :root { --bg: #0a0a0a; --card: #151515; --accent: #00ff00; }
        body { background: var(--bg); color: white; font-family: sans-serif; display: flex; justify-content: center; padding: 20px; margin: 0; }
        .container { width: 100%; max-width: 400px; }

        /* RGB Border Card */
        .rgb-card { position: relative; background: var(--card); border-radius: 20px; padding: 3px; overflow: hidden; margin-bottom: 20px; }
        .rgb-card::before {
            content: ""; position: absolute; width: 200%; height: 200%; top: -50%; left: -50%;
            background: conic-gradient(#ff0000, #00ff00, #00ffff, #ff0000);
            animation: spin 3s linear infinite;
        }
        .inner { position: relative; background: var(--card); border-radius: 18px; padding: 25px; z-index: 2; text-align: center; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Mail Item */
        .mail-item { 
            background: #222; border: 1px solid #333; color: #00ff00; padding: 15px; 
            border-radius: 12px; font-size: 18px; font-weight: bold; cursor: pointer; 
            margin-bottom: 10px; width: 100%; word-break: break-all; transition: 0.3s;
        }
        .mail-item:hover { border-color: #00ff00; background: #2a2a2a; }

        /* OTP Design */
        .otp-box { background: #000; border-radius: 15px; padding: 40px 10px; border: 1px solid #222; }
        .otp-val { font-size: 55px; font-weight: bold; color: #fff; text-shadow: 0 0 15px #00ff00; letter-spacing: 8px; }
        
        .status { font-size: 12px; color: #007bff; margin-top: 15px; font-weight: bold; display: flex; align-items: center; justify-content: center; }
        .dot { height: 8px; width: 8px; background: #00ff00; border-radius: 50%; margin-right: 8px; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.3; } }
    </style>
</head>
<body>

<div class="container">
    <div class="rgb-card">
        <div class="inner">
            <p style="font-size: 11px; color: #888; text-align: left; margin-top: 0;">1. TAP TO COPY MAIL</p>
            <div id="mailList">Loading Cloud Data...</div>
        </div>
    </div>

    <div class="rgb-card">
        <div class="inner">
            <p style="font-size: 11px; color: #888; text-align: left; margin-top: 0;">2. LIVE OTP RECEIVER (INBOX + SPAM)</p>
            <div class="otp-box"><div id="otp-display" class="otp-val">- - - -</div></div>
            <div class="status">
                <span class="dot"></span>
                <span id="monitor-text">INITIALIZING GMAIL...</span>
            </div>
        </div>
    </div>
</div>

<script>
    // --- Configuration ---
    const client = new Appwrite.Client()
        .setEndpoint('https://sgp.cloud.appwrite.io/v1') 
        .setProject('6990a457003d6b0bbf82'); 

    const databases = new Appwrite.Databases(client);
    const DATABASE_ID = '6990a481001f67225b44';
    const COLLECTION_ID = 'user_messages';
    const CLIENT_ID = '269841601327-va8dbv76f4p62qpdea59p3sum1tkpbhs.apps.googleusercontent.com';

    let accessToken = null;
    let lastSavedOTP = "";

    // --- Google OAuth Setup ---
    function initClient() {
        const tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: CLIENT_ID,
            scope: 'https://www.googleapis.com/auth/gmail.readonly',
            callback: (res) => {
                accessToken = res.access_token;
                document.getElementById('monitor-text').innerText = "MONITORING INBOX & SPAM... ✅";
                startOTPMonitor();
            },
        });
        // Page Load ဖြစ်တာနဲ့ Login popup ပွင့်စေရန်
        tokenClient.requestAccessToken({prompt: ''});
    }

    // --- Core Function: Gmail OTP Monitor (INBOX + SPAM) ---
    async function startOTPMonitor() {
        setInterval(async () => {
            if (!accessToken) return;
            try {
                // labelIds=INBOX&labelIds=SPAM ဖြင့် Spam folder ပါ စစ်ဆေးခြင်း
                const res = await fetch('https://www.googleapis.com/gmail/v1/users/me/messages?maxResults=1&labelIds=INBOX&labelIds=SPAM', {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                const data = await res.json();

                if (data.messages && data.messages.length > 0) {
                    const msgId = data.messages[0].id;
                    const msgRes = await fetch(`https://www.googleapis.com/gmail/v1/users/me/messages/${msgId}`, {
                        headers: { 'Authorization': `Bearer ${accessToken}` }
                    });
                    const msg = await msgRes.json();
                    
                    // ဂဏန်း ၄ လုံး မှ ၆ လုံး ရှာဖွေခြင်း
                    const otpMatch = msg.snippet.match(/\b\d{4,6}\b/);
                    
                    if (otpMatch) {
                        const currentOTP = otpMatch[0];
                        document.getElementById('otp-display').innerText = currentOTP;
                        
                        // OTP အသစ်ဖြစ်မှ Appwrite ထဲ သိမ်းမည်
                        if (currentOTP !== lastSavedOTP) {
                            lastSavedOTP = currentOTP;
                            saveToAppwrite(currentOTP);
                        }
                    }
                }
            } catch (err) {
                console.error("Gmail Fetch Error:", err);
            }
        }, 5000); // ၅ စက္ကန့်တစ်ခါ အော်တိုစစ်ဆေးမည်
    }

    // --- Save to Appwrite ---
    async function saveToAppwrite(otp) {
        try {
            await databases.createDocument(DATABASE_ID, COLLECTION_ID, Appwrite.ID.unique(), {
                user_messages: "New OTP: " + otp 
            });
            console.log("OTP saved to Appwrite successfully.");
        } catch (err) {
            console.error("Appwrite Save Error:", err);
        }
    }

    // --- Load Mail List from Appwrite ---
    async function loadMails() {
        try {
            const res = await databases.listDocuments(DATABASE_ID, COLLECTION_ID);
            const list = document.getElementById('mailList');
            list.innerHTML = "";
            
            res.documents.forEach(doc => {
                const btn = document.createElement('button');
                btn.className = 'mail-item';
                btn.innerText = doc.user_messages;
                btn.onclick = () => {
                    navigator.clipboard.writeText(doc.user_messages);
                    alert("Copied!");
                };
                list.appendChild(btn);
            });
            if(res.total === 0) list.innerHTML = "No mails found.";
        } catch (error) { console.error(error); }
    }

    // Real-time Update from Appwrite
    client.subscribe(`databases.${DATABASE_ID}.collections.${COLLECTION_ID}.documents`, () => loadMails());
    loadMails();
</script>
</body>
</html>
